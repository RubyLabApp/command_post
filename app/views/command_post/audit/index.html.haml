.p-8.max-w-7xl.mx-auto{ class: t.font_family }
  .flex.items-center.justify-between.mb-6
    %h1.text-2xl{ class: cp_heading } Audit Log

  - unless CommandPost.configuration.audit_enabled
    .rounded-lg.border.border-yellow-200.bg-yellow-50.p-4.mb-6
      .flex
        .flex-shrink-0
          = heroicon "exclamation-triangle", variant: :mini, options: { class: "h-5 w-5 text-yellow-400" }
        .ml-3
          %p.text-sm.text-yellow-700
            Audit logging is currently disabled. Enable it in your CommandPost configuration:
            %code.ml-1.px-1.py-0.5.bg-yellow-100.rounded config.audit_enabled = true

  - if @entries.any?
    .mb-4
      = form_tag audit_path, method: :get, class: "flex gap-4 items-end" do
        .flex-1
          %label.block.text-xs.font-semibold.uppercase.tracking-wider.mb-1{ class: cp_muted_text } Resource
          %select{ name: "resource", class: cp_select_class }
            %option{ value: "" } All Resources
            - CommandPost::ResourceRegistry.all.each do |resource|
              %option{ value: resource.name, selected: params[:resource] == resource.name }= resource.label
        .flex-1
          %label.block.text-xs.font-semibold.uppercase.tracking-wider.mb-1{ class: cp_muted_text } Action
          %select{ name: "action_filter", class: cp_select_class }
            %option{ value: "" } All Actions
            - %w[create update destroy].each do |action|
              %option{ value: action, selected: params[:action_filter] == action }= action.capitalize
        .flex-1
          %label.block.text-xs.font-semibold.uppercase.tracking-wider.mb-1{ class: cp_muted_text } From
          = date_field_tag :from, params[:from], class: cp_filter_input_class
        .flex-1
          %label.block.text-xs.font-semibold.uppercase.tracking-wider.mb-1{ class: cp_muted_text } To
          = date_field_tag :to, params[:to], class: cp_filter_input_class
        .flex.gap-2
          %button{ type: "submit", class: cp_btn_primary } Filter
          = link_to "Clear", audit_path, class: cp_btn_ghost

    %table.min-w-full{ class: "#{cp_table_border} divide-y #{t.card_bg} #{t.border_radius} #{t.card_shadow}" }
      %thead{ class: cp_table_header_bg }
        %tr
          %th.px-6.py-3.text-left.text-xs.font-medium.uppercase.tracking-wider{ class: cp_muted_text } Timestamp
          %th.px-6.py-3.text-left.text-xs.font-medium.uppercase.tracking-wider{ class: cp_muted_text } User
          %th.px-6.py-3.text-left.text-xs.font-medium.uppercase.tracking-wider{ class: cp_muted_text } Action
          %th.px-6.py-3.text-left.text-xs.font-medium.uppercase.tracking-wider{ class: cp_muted_text } Resource
          %th.px-6.py-3.text-left.text-xs.font-medium.uppercase.tracking-wider{ class: cp_muted_text } Record ID
          %th.px-6.py-3.text-left.text-xs.font-medium.uppercase.tracking-wider{ class: cp_muted_text } IP Address
          %th.px-6.py-3.text-left.text-xs.font-medium.uppercase.tracking-wider{ class: cp_muted_text } Changes
      %tbody{ class: "#{cp_table_border} divide-y" }
        - @entries.each do |entry|
          %tr{ class: cp_table_row_hover }
            %td.px-6.py-4.whitespace-nowrap.text-sm{ class: cp_body_text }
              = entry.timestamp.strftime("%Y-%m-%d %H:%M:%S")
            %td.px-6.py-4.whitespace-nowrap.text-sm{ class: cp_body_text }
              - if entry.user.respond_to?(:email)
                = entry.user.email
              - elsif entry.user.respond_to?(:name)
                = entry.user.name
              - elsif entry.user
                = entry.user.to_s
              - else
                %span{ class: cp_muted_text } Unknown
            %td.px-6.py-4.whitespace-nowrap.text-sm
              - action_colors = { create: "green", update: "blue", destroy: "red" }
              - color = action_colors[entry.action.to_sym] || "gray"
              %span{ class: "inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-#{color}-100 text-#{color}-800" }
                = entry.action.to_s.capitalize
            %td.px-6.py-4.whitespace-nowrap.text-sm{ class: cp_body_text }
              = entry.resource
            %td.px-6.py-4.whitespace-nowrap.text-sm{ class: cp_body_text }
              = entry.record_id
            %td.px-6.py-4.whitespace-nowrap.text-sm{ class: cp_muted_text }
              = entry.ip_address || "-"
            %td.px-6.py-4.text-sm{ class: cp_body_text }
              - if entry.changes.present? && entry.changes.any?
                %details
                  %summary.cursor-pointer{ class: cp_link }
                    = pluralize(entry.changes.keys.count, "field")
                    changed
                  .mt-2.text-xs.font-mono.bg-gray-50.p-2.rounded.max-w-md.overflow-auto
                    - entry.changes.each do |field, values|
                      .mb-1
                        %strong= field
                        \:
                        - if values.is_a?(Array) && values.length == 2
                          %span{ class: "text-red-600 line-through" }= values[0].to_s.truncate(30)
                          = heroicon "arrow-right", variant: :mini, options: { class: "h-3 w-3 inline mx-1" }
                          %span{ class: "text-green-600" }= values[1].to_s.truncate(30)
                        - else
                          = values.to_s.truncate(50)
              - else
                %span{ class: cp_muted_text } -

  - else
    .text-center.py-12{ class: cp_muted_text }
      = heroicon "clipboard-document-list", variant: :outline, options: { class: "h-12 w-12 mx-auto mb-4" }
      %p.text-lg.font-medium No audit log entries found.
      %p.text-sm.mt-2 Activity will appear here once users perform actions.
