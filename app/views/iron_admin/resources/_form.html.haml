= form_with model: @record, url: form_url, scope: :record, html: { multipart: true } do |f|
  %div{ class: t.form.grid }
    - @fields.each do |field|
      - next unless field.visible?(iron_admin_current_user)
      - next if field.readonly?(iron_admin_current_user)
      - span_full = field.type.in?(%i[textarea json file files rich_text tags markdown])
      - has_error = @record.errors[field.name].any?
      %div{ class: span_full ? t.form.wrapper_span_full : nil }
        = f.label field.name, field.name.to_s.humanize,
          class: "#{t.form.label} #{cp_label_text} #{t.form.label_margin}"
        - case field.type
        - when :belongs_to
          - assoc_class = field.options[:association_class]
          - fk = field.options[:foreign_key]
          - display_method = field.options[:display]
          = f.select fk,
            options_from_collection_for_select(assoc_class.all, :id, (display_method || :name), @record.public_send(fk)),
            { include_blank: I18n.t("iron_admin.fields.select_placeholder") },
            class: [cp_select_class, (t.form.error_border if has_error)].compact.join(" ")
        - when :text
          = f.text_field field.name, placeholder: field.name.to_s.humanize,
            class: [cp_input_class, (t.form.error_border if has_error)].compact.join(" ")
        - when :textarea
          = f.text_area field.name, rows: 4, placeholder: field.name.to_s.humanize,
            class: [cp_textarea_class, (t.form.error_border if has_error)].compact.join(" ")
        - when :number
          = f.number_field field.name, placeholder: I18n.t("iron_admin.fields.number_placeholder"),
            class: [cp_input_class, (t.form.error_border if has_error)].compact.join(" ")
        - when :boolean
          %div{ class: t.form.boolean_wrapper }
            = f.check_box field.name, class: cp_checkbox_class
            %span.text-sm{ class: cp_muted_text }= I18n.t("iron_admin.fields.boolean_enable", field: field.name.to_s.humanize.downcase)
        - when :datetime, :date
          = f.datetime_local_field field.name,
            class: [cp_input_class, (t.form.error_border if has_error)].compact.join(" ")
        - when :badge
          - badge_choices = field.options[:colors]&.keys&.map(&:to_s)
          - badge_choices ||= @record.class.defined_enums[field.name.to_s]&.keys if @record.class.respond_to?(:defined_enums)
          - badge_choices ||= []
          = f.select field.name, badge_choices.map { |c| [c.humanize, c] },
            { include_blank: I18n.t("iron_admin.fields.select_placeholder") },
            class: [cp_select_class, (t.form.error_border if has_error)].compact.join(" ")
        - when :select
          = f.select field.name, field.options[:choices]&.map { |c| [c.humanize, c] },
            { include_blank: I18n.t("iron_admin.fields.select_placeholder") },
            class: [cp_select_class, (t.form.error_border if has_error)].compact.join(" ")
        - when :password
          = f.password_field field.name, placeholder: field.name.to_s.humanize, autocomplete: "new-password",
            class: [cp_input_class, (t.form.error_border if has_error)].compact.join(" ")
        - when :url
          = f.url_field field.name, placeholder: I18n.t("iron_admin.fields.url_placeholder"),
            class: [cp_input_class, (t.form.error_border if has_error)].compact.join(" ")
        - when :email
          = f.email_field field.name, placeholder: I18n.t("iron_admin.fields.email_placeholder"),
            class: [cp_input_class, (t.form.error_border if has_error)].compact.join(" ")
        - when :color
          .flex.items-center.gap-3
            = f.color_field field.name, class: t.form.color_picker
            = f.text_field field.name, placeholder: I18n.t("iron_admin.fields.color_placeholder"),
              class: [cp_input_class, "flex-1 font-mono text-sm", (t.form.error_border if has_error)].compact.join(" "),
              data: { color_text: true }
        - when :currency
          .relative
            %span{ class: "#{t.form.currency_symbol} #{cp_muted_text}" }
              = field.options[:symbol] || "$"
            = f.number_field field.name, step: "0.01", placeholder: I18n.t("iron_admin.fields.currency_placeholder"),
              class: [cp_input_class, "pl-7", (t.form.error_border if has_error)].compact.join(" ")
        - when :file
          - attachment = @record.public_send(field.name) if @record.respond_to?(field.name)
          - if attachment&.attached?
            %div{ class: "#{t.form.file_preview} #{t.card_border} #{t.card_bg}" }
              - if attachment.image?
                = image_tag main_app.url_for(attachment), class: t.display.file_image
              - else
                .flex.items-center.gap-2
                  = heroicon "paper-clip", variant: :mini, options: { class: "h-5 w-5 #{cp_muted_text}" }
                  %span.text-sm{ class: cp_body_text }= attachment.filename
              .ml-auto
                = f.label "#{field.name}_purge", class: "flex items-center gap-1.5 text-sm #{t.form.error_text} cursor-pointer" do
                  = check_box_tag "record[#{field.name}_purge]", "1", false, id: "#{field.name}_purge", class: cp_checkbox_class
                  = I18n.t("iron_admin.fields.file_remove")
          = f.file_field field.name,
            class: [cp_file_input_class, (t.form.error_border if has_error)].compact.join(" ")
        - when :files
          - attachments = @record.public_send(field.name) if @record.respond_to?(field.name)
          - if attachments&.attached?
            .flex.flex-wrap.gap-3.mb-2
              - attachments.each do |attachment|
                %div{ class: "flex items-center gap-2 p-2 rounded-lg border #{t.card_border} #{t.card_bg}" }
                  - if attachment.image?
                    = image_tag main_app.url_for(attachment), class: t.display.file_image_small
                  - else
                    .flex.items-center{ class: "gap-1.5" }
                      = heroicon "paper-clip", variant: :mini, options: { class: "h-4 w-4 #{cp_muted_text}" }
                      %span.text-xs{ class: cp_body_text }= attachment.filename
          = f.file_field field.name, multiple: true,
            class: [cp_file_input_class, (t.form.error_border if has_error)].compact.join(" ")
        - when :markdown
          = f.text_area field.name, rows: 8, placeholder: I18n.t("iron_admin.fields.markdown_placeholder"),
            class: [cp_textarea_class, "font-mono text-sm", (t.form.error_border if has_error)].compact.join(" ")
        - when :rich_text
          = f.rich_text_area field.name, class: "trix-content"
        - when :polymorphic_belongs_to
          - types = field.options[:types] || []
          - type_col = field.options[:type_column]
          - id_col = field.options[:id_column]
          - current_type = @record.public_send(type_col)
          - current_id = @record.public_send(id_col)
          .space-y-2
            = f.select type_col,
              types.map { |klass| [klass.model_name.human, klass.name] },
              { include_blank: I18n.t("iron_admin.fields.select_placeholder"), selected: current_type },
              class: [cp_select_class, (t.form.error_border if has_error)].compact.join(" ")
            = f.select id_col,
              (current_type.present? ? current_type.constantize.all.map { |r| [display_record_label(r), r.id] } : []),
              { include_blank: I18n.t("iron_admin.fields.select_placeholder"), selected: current_id },
              class: [cp_select_class, (t.form.error_border if has_error)].compact.join(" ")
        - when :tags
          - current_tags = @record.public_send(field.name)
          - tag_values = current_tags.is_a?(Array) ? current_tags : current_tags.to_s.split(",").map(&:strip).reject(&:blank?)
          - container_id = "tags-container-#{field.name}"
          %div{ id: container_id, data: { tags_field: true,
                tag_chip_class: "#{t.form.tag_chip} #{t.display.tag}",
                tag_remove_class: "#{t.form.tag_remove} #{t.display.tag.include?('indigo') ? 'text-indigo-400 hover:text-indigo-600' : cp_muted_text}" } }
            = f.hidden_field field.name, value: tag_values.join(","), id: "tags-hidden-#{field.name}"
            .flex.flex-wrap.gap-2.mb-2{ data: { tags_list: true } }
              - tag_values.each do |tag_value|
                %span{ class: "#{t.form.tag_chip} #{t.display.tag}", data: { tag: true } }
                  = tag_value
                  %button{ type: "button", class: "#{t.form.tag_remove} text-indigo-400 hover:text-indigo-600",
                           data: { remove_tag: true } } &times;
            .flex.items-center.gap-2
              %input.flex-1{ type: "text", placeholder: I18n.t("iron_admin.fields.tags_placeholder"), data: { tag_input: true },
                class: [cp_input_class, (t.form.error_border if has_error)].compact.join(" ") }
          :javascript
            (function() {
              const container = document.getElementById("#{container_id}");
              const hidden = container.querySelector("[data-tags-list] ~ .flex input[data-tag-input]").closest("[data-tags-field]").querySelector("input[type=hidden]");
              const list = container.querySelector("[data-tags-list]");
              const input = container.querySelector("[data-tag-input]");
              const chipClass = container.dataset.tagChipClass;
              const removeClass = container.dataset.tagRemoveClass;

              function updateHidden() {
                const tags = Array.from(list.querySelectorAll("[data-tag]")).map(el => el.textContent.replace("\u00d7", "").trim());
                hidden.value = tags.join(",");
              }

              function addTag(value) {
                const trimmed = value.trim();
                if (!trimmed) return;
                const existing = Array.from(list.querySelectorAll("[data-tag]")).map(el => el.textContent.replace("\u00d7", "").trim());
                if (existing.includes(trimmed)) return;

                const span = document.createElement("span");
                span.className = chipClass;
                span.dataset.tag = true;
                span.textContent = trimmed;
                const btn = document.createElement("button");
                btn.type = "button";
                btn.className = removeClass;
                btn.dataset.removeTag = true;
                btn.textContent = "\u00d7";
                btn.addEventListener("click", function() { span.remove(); updateHidden(); });
                span.appendChild(btn);
                list.appendChild(span);
                updateHidden();
              }

              input.addEventListener("keydown", function(e) {
                if (e.key === "Enter" || e.key === ",") {
                  e.preventDefault();
                  addTag(input.value);
                  input.value = "";
                }
              });

              input.addEventListener("blur", function() {
                if (input.value.trim()) { addTag(input.value); input.value = ""; }
              });

              list.querySelectorAll("[data-remove-tag]").forEach(function(btn) {
                btn.addEventListener("click", function() { btn.closest("[data-tag]").remove(); updateHidden(); });
              });
            })();
        - else
          - custom_config = IronAdmin::FieldTypeRegistry.find(field.type) if IronAdmin::FieldTypeRegistry.registered?(field.type)
          - if custom_config&.form_component_class
            = render custom_config.form_component_class.new(form: f, field: field, record: @record)
          - elsif custom_config&.form_partial_path
            = render partial: custom_config.form_partial_path, locals: { f: f, field: field, record: @record }
          - else
            = f.text_field field.name, placeholder: field.name.to_s.humanize,
              class: [cp_input_class, (t.form.error_border if has_error)].compact.join(" ")

        - if has_error
          %div{ class: t.form.error_container }
            = heroicon "exclamation-circle", variant: :mini, options: { class: t.form.error_icon }
            %p{ class: t.form.error_text }= @record.errors[field.name].join(", ")

  - @resource_class.habtm_associations.each do |assoc|
    %div{ class: "#{t.form.wrapper_span_full} mt-4" }
      %label{ class: "#{t.form.label} mb-2 #{cp_label_text}" }= assoc[:name].to_s.humanize
      - all_options = assoc[:reflection].klass.all
      - selected_ids = @record.public_send(assoc[:name]).pluck(:id)
      .flex.flex-wrap.gap-3
        - all_options.each do |option|
          %label.inline-flex.items-center.gap-2.cursor-pointer
            = check_box_tag "record[#{assoc[:name].to_s.singularize}_ids][]", option.id, selected_ids.include?(option.id), class: cp_checkbox_class
            %span.text-sm{ class: cp_body_text }= display_record_label(option, assoc[:display])

  %div{ class: "#{t.form.actions} #{t.card_border}" }
    = f.submit class: cp_btn_primary_lg
    = link_to I18n.t("iron_admin.form.cancel_button"), resources_path(@resource_class.resource_name),
      class: cp_btn_secondary
